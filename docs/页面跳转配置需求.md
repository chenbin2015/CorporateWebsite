# 页面跳转配置需求文档

## 1. 需求概述

在可视化页面搭建系统中，需要实现页面跳转配置功能，支持组件级别的跳转配置，包括：
- 列表项跳转到详情页（参数化跳转）
- 导航项跳转到不同页面
- 按钮/链接跳转到目标页面
- 支持外部链接跳转
- 支持详情页模板选择

## 2. 场景分析

### 2.1 场景1：列表项 → 详情页（参数化跳转）

**适用组件：**
- `NewsSection`（新闻列表）
- `EventSpotlight`（活动列表）
- `NoticeList`（公告列表）

**特点：**
- 列表项共享同一个详情页模板
- 仅通过参数区分不同项（如 `/news/:id`）
- 参数值从列表项的某个字段获取（如 `item.id`）

**配置方式：**
- 在组件级别配置详情页模板类型
- 配置参数名和参数来源字段

### 2.2 场景2：导航项 → 不同页面

**适用组件：**
- `MainHeader`（主导航）
- `TabsNav`（标签导航）
- `TopLinksBar`（顶部链接条）
- `BreadcrumbHeader`（面包屑导航，可选跳转）

**特点：**
- 每个导航项跳转到不同的页面
- 这些页面都是项目内已配置的页面
- 从项目页面列表中选择，不允许手动输入

**配置方式：**
- 在 items 数组中为每个项独立配置跳转

### 2.3 场景3：单个按钮 → 目标页面

**适用组件：**
- `CTABanner`（行动召唤条）
- `PageHero`（页面头部）
- `SectionHero`（分区英雄横幅）
- `ContentSplit`（内容分割）

**特点：**
- 单个按钮/链接，跳转到一个目标
- 可以是项目内页面或外部链接

**配置方式：**
- 在组件 props 中直接配置跳转

### 2.4 场景4：卡片网格 → 统一详情页模板 + 可单独覆盖

**适用组件：**
- `InfoCardGrid`（信息卡片网格）
- `FocusGrid`（专题网格）
- `CardGrid`（卡片网格）
- `ServiceLinks`（服务链接）

**特点：**
- 默认：组件级别统一配置详情页模板（适合同类型内容）
- 高级：允许某个卡片单独配置跳转（覆盖统一配置）

**配置方式：**
- 统一配置：在组件级别配置详情页模板
- 单独配置：在 cards/items 数组中为某个项单独配置

### 2.5 场景5：轮播图 → 统一配置

**适用组件：**
- `HeroCarousel`（首页轮播）

**特点：**
- 所有 slide 跳转到同一个目标页面
- 统一配置，不需要为每个 slide 单独配置

**配置方式：**
- 在组件级别统一配置跳转目标

### 2.6 场景6：其他链接

**适用组件：**
- `DownloadList`（下载列表）- 通常是外部资源链接
- `CardGrid.footerLink`（"查看更多"链接）
- `NewsSection.moreText`（"更多"链接）
- `EventSpotlight.moreText`（"更多"链接）

**特点：**
- 可能是外部链接或内部页面
- 需要支持配置

**配置方式：**
- 在组件 props 中配置 `moreLink` 或 `footerLink`

## 3. 详情页模板系统

### 3.1 设计理念

采用**混合方案**：
- 普通页面：完全可编排（用组件搭建）
- 详情页：预设模板，用户选择使用哪个模板

### 3.2 预设模板类型

系统预设以下详情页模板：

1. **新闻详情页模板**（NewsDetail）
   - 路径模板：`/news/:id`
   - 适用：新闻列表项

2. **活动详情页模板**（EventDetail）
   - 路径模板：`/events/:id`
   - 适用：活动列表项

3. **公告详情页模板**（NoticeDetail）
   - 路径模板：`/notices/:id`
   - 适用：公告列表项

4. **专题详情页模板**（FocusDetail，可选）
   - 路径模板：`/focus/:id`
   - 适用：专题卡片

### 3.3 模板管理

- 模板在系统中预设，不在页面搭建器中编辑
- 模板可以独立维护和升级
- 用户只需选择模板类型，不需要从零搭建
- 可选：用户也可以选择项目内自己搭建的页面作为详情页

### 3.4 模板配置选项

```javascript
{
  type: "template",  // template | custom
  templateType: "news",  // news | event | notice | focus
  // 或者选择自定义页面
  // type: "custom",
  // targetPageId: 123,
}
```

## 4. 数据结构设计

### 4.1 跳转配置基础结构

```javascript
{
  type: "page" | "url" | "none",  // 页面跳转 | 外部链接 | 无跳转
  targetPageId: number,  // 项目内的页面ID（type=page时）
  url: string,  // 外部URL（type=url时）
  paramKey: string,  // 路径参数名，如 "id"（用于详情页场景）
  paramSource: string,  // 从item的哪个字段取值，如 "id" 或 "newsId"
  params: object  // 静态参数（可选）
}
```

### 4.2 列表详情页配置

```javascript
{
  key: "NewsSection",
  props: {
    title: "最新新闻",
    items: [...],
    // 详情页配置
    detailPage: {
      type: "template",  // template | custom
      templateType: "news",  // news | event | notice | focus
      // 或者选择自定义页面
      // type: "custom",
      // targetPageId: 123,
      paramKey: "id",  // URL参数名
      paramSource: "id"  // 从item的哪个字段取值
    }
  }
}
```

### 4.3 导航项跳转配置

```javascript
{
  key: "TabsNav",
  props: {
    items: [
      {
        label: "首页",
        value: "home",
        // 每个项独立配置跳转
        navigation: {
          type: "page",  // page | url | none
          targetPageId: 1,  // 选择项目内的页面
          // 或者外部链接
          // url: "https://example.com"
        }
      },
      {
        label: "关于我们",
        value: "about",
        navigation: {
          type: "page",
          targetPageId: 2,
        }
      }
    ]
  }
}
```

### 4.4 按钮跳转配置

```javascript
{
  key: "CTABanner",
  props: {
    title: "预约参观",
    buttonText: "立即预约",
    navigation: {
      type: "page",  // page | url | none
      targetPageId: 3,
      // 可选参数
      params: {
        source: "homepage"
      }
    }
  }
}
```

### 4.5 卡片网格配置（统一+单独覆盖）

```javascript
{
  key: "InfoCardGrid",
  props: {
    title: "核心服务",
    cards: [
      {
        title: "服务A",
        description: "...",
        // 使用统一配置，不需要单独配置
      },
      {
        title: "服务B",
        description: "...",
        // 单独覆盖配置
        navigation: {
          type: "page",
          targetPageId: 5,
        }
      }
    ],
    // 统一详情页配置
    detailPage: {
      type: "template",
      templateType: "focus",
      paramKey: "id",
      paramSource: "id"
    }
  }
}
```

## 5. 组件分类标记

在 `componentPalette.js` 中为每个组件标记跳转类型：

```javascript
{
  key: 'NewsSection',
  label: 'NewsSection',
  navigationType: 'list-detail',  // 列表详情页
  // ...
},
{
  key: 'TabsNav',
  label: 'TabsNav',
  navigationType: 'nav-items',  // 导航项
  // ...
},
{
  key: 'CTABanner',
  label: 'CTABanner',
  navigationType: 'single-button',  // 单个按钮
  // ...
},
{
  key: 'InfoCardGrid',
  label: 'InfoCardGrid',
  navigationType: 'card-grid',  // 卡片网格（支持统一+单独覆盖）
  // ...
},
{
  key: 'HeroCarousel',
  label: 'HeroCarousel',
  navigationType: 'carousel',  // 轮播图统一配置
  // ...
}
```

### 5.1 跳转类型枚举

- `list-detail`: 场景1（列表详情页）
- `nav-items`: 场景2（导航项）
- `single-button`: 场景3（单个按钮）
- `card-grid`: 场景4（卡片网格，支持统一+单独覆盖）
- `carousel`: 场景5（轮播图统一配置）
- `mixed`: 场景6（混合场景，灵活配置）

## 6. 参数传递方式

### 6.1 路径参数模式

采用路径参数模式，如：
- `/news/:id`
- `/events/:id`
- `/notices/:id`

### 6.2 参数来源

参数值从列表项的指定字段获取：
- 默认字段：`id`
- 可配置字段：`newsId`、`eventId`、`noticeId` 等

### 6.3 静态参数

支持传递静态参数（可选）：
```javascript
{
  navigation: {
    type: "page",
    targetPageId: 3,
    params: {
      source: "homepage",
      campaign: "spring2024"
    }
  }
}
```

## 7. 配置界面设计

### 7.1 列表详情页配置UI

在属性面板中显示"详情页配置"区域：
- 详情页类型选择器（模板类型或自定义页面）
- 如果选择模板：显示模板类型下拉选择（新闻/活动/公告/专题）
- 如果选择自定义：显示页面选择器（下拉选择项目内的页面）
- 参数配置：
  - 参数名输入框（如 "id"）
  - 参数来源字段选择器（从 item 的哪个字段取值）

### 7.2 导航项跳转配置UI

在 items 数组编辑器中：
- 为每个项添加"跳转配置"按钮
- 点击后弹出对话框：
  - 跳转类型选择器（页面跳转/外部链接/无跳转）
  - 如果选择页面跳转：显示页面选择器（下拉选择项目内的页面）
  - 如果选择外部链接：显示URL输入框

### 7.3 按钮跳转配置UI

在属性面板中显示"跳转配置"区域：
- 跳转类型选择器
- 页面选择器或外部URL输入框
- 参数配置（可选，键值对编辑器）

### 7.4 卡片网格配置UI

- 统一配置：在组件级别显示详情页配置（同列表详情页）
- 单独配置：在 cards/items 编辑器中，为某个项添加跳转配置（同导航项）

### 7.5 页面选择器组件

创建一个通用的页面选择器组件：
- 下拉选择项目内的所有页面
- 显示页面名称和路径
- 支持搜索过滤

## 8. 运行时跳转处理

### 8.1 统一跳转处理函数

在 `frontend` 项目中创建统一的跳转处理函数：

```javascript
// utils/navigation.js
export function handleNavigation(navigation, item = null) {
  if (!navigation || navigation.type === 'none') {
    return
  }
  
  if (navigation.type === 'url') {
    window.open(navigation.url, '_blank')
    return
  }
  
  if (navigation.type === 'page') {
    let path = getPagePath(navigation.targetPageId)
    
    // 处理路径参数
    if (navigation.paramKey && item) {
      const paramValue = item[navigation.paramSource || 'id']
      path = path.replace(`:${navigation.paramKey}`, paramValue)
    }
    
    // 处理静态参数
    if (navigation.params) {
      const query = new URLSearchParams(navigation.params).toString()
      path += `?${query}`
    }
    
    router.push(path)
  }
}
```

### 8.2 组件修改

修改所有共享组件，使用统一的跳转处理：
- 将 `<a href="...">` 改为 `<a @click="handleNavigation(...)">`
- 或者使用 Vue Router 的 `router-link`

### 8.3 详情页路由

在 `frontend` 路由中配置动态详情页路由：
```javascript
{
  path: '/news/:id',
  name: 'newsDetail',
  component: () => import('@/views/templates/NewsDetail.vue')
},
{
  path: '/events/:id',
  name: 'eventDetail',
  component: () => import('@/views/templates/EventDetail.vue')
},
// ...
```

## 9. 边界情况处理

### 9.1 跳转配置验证

- **目标页面被删除**：显示警告提示，允许用户重新选择
- **详情页模板不存在**：显示错误提示，引导用户选择其他模板
- **参数字段不存在**：显示警告，使用默认值或跳过参数

### 9.2 预览模式下的跳转

在 `PagePreview` 中：
- 方案A：禁用跳转，显示提示
- 方案B：跳转到真实的预览页面（如果已发布）
- 方案C：Mock 跳转，显示跳转目标信息

### 9.3 "更多"链接配置

为以下组件添加 `moreLink` 配置：
- `NewsSection.moreText`
- `EventSpotlight.moreText`
- `CardGrid.footerLink`

配置方式同按钮跳转配置。

### 9.4 面包屑导航

`BreadcrumbHeader` 支持可选跳转：
- 默认：仅展示层级，不跳转
- 可选：为每个层级配置跳转

### 9.5 下载链接

`DownloadList` 的下载链接：
- 通常是外部资源链接
- 不需要跳转配置，直接使用 `href`
- 或者支持配置为外部链接类型

### 9.6 默认值

新建组件时：
- 跳转配置默认为 `type: "none"`（无跳转）
- 用户需要主动配置跳转

## 10. 实现步骤

### Phase 1: 基础框架（核心功能）

1. 定义跳转数据结构
2. 扩展组件 schema，标记跳转类型
3. 实现页面选择器组件
4. 在属性面板中添加跳转配置UI（先实现按钮跳转，最简单）
5. 实现运行时跳转处理函数

### Phase 2: 列表详情页跳转

1. 在列表类组件的属性面板中添加详情页配置
2. 实现详情页模板选择器
3. 修改列表组件，支持从 item 数据中提取参数
4. 实现详情页路由和模板组件

### Phase 3: 导航项跳转

1. 在导航类组件的 items 编辑器中添加跳转配置
2. 实现数组项级别的跳转配置UI
3. 修改导航组件，支持跳转

### Phase 4: 卡片网格和轮播图

1. 实现卡片网格的统一配置和单独覆盖
2. 实现轮播图的统一配置
3. 实现"更多"链接配置

### Phase 5: 边界情况处理

1. 实现跳转配置验证
2. 处理预览模式下的跳转
3. 完善错误提示和用户引导

## 11. 数据库扩展（可选）

如果需要持久化跳转关系用于分析，可以创建 `page_navigations` 表：

```sql
CREATE TABLE page_navigations (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  project_id BIGINT NOT NULL,
  source_page_id BIGINT NOT NULL,
  target_page_id BIGINT,
  component_id VARCHAR(255),  -- 组件实例ID
  navigation_type VARCHAR(32),  -- page | url
  template_type VARCHAR(32),  -- news | event | notice | focus
  params JSON,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (project_id) REFERENCES projects(id),
  FOREIGN KEY (source_page_id) REFERENCES pages(id),
  FOREIGN KEY (target_page_id) REFERENCES pages(id)
);
```

## 12. 技术要点

### 12.1 路径参数处理

- 使用 Vue Router 的动态路由
- 参数从 URL 中提取：`route.params.id`
- 详情页组件根据参数调用 API 获取数据

### 12.2 页面选择器实现

- 调用 API 获取项目内的所有页面列表
- 下拉选择器显示页面名称和路径
- 支持搜索和过滤

### 12.3 组件修改策略

- 保持向后兼容，现有组件不配置跳转时保持原有行为
- 逐步迁移组件，使用统一的跳转处理函数
- 支持混合模式：部分组件使用新跳转，部分保持旧链接

## 13. 验收标准

1. ✅ 列表组件可以配置详情页模板，点击列表项跳转到详情页
2. ✅ 导航组件可以为每个项配置跳转，跳转到项目内的不同页面
3. ✅ 按钮组件可以配置跳转，支持内部页面和外部链接
4. ✅ 卡片网格支持统一配置和单独覆盖
5. ✅ 轮播图支持统一配置跳转
6. ✅ 支持外部链接跳转
7. ✅ 跳转配置有验证和错误提示
8. ✅ 预览模式下跳转行为合理

## 14. 后续优化

1. 跳转关系可视化（页面关系图）
2. 跳转分析统计（哪些页面跳转最多）
3. 批量配置跳转
4. 跳转配置模板/预设
5. 条件跳转（根据某些条件决定跳转目标）

---

**文档版本：** v1.0  
**创建日期：** 2025-01-XX  
**最后更新：** 2025-01-XX

